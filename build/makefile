include defines.mk

ZQCommon       := $(_prefix)/Common 
HttpEngine     := $(_prefix)/Common/HttpEngine 
DataPostHouse  := $(_prefix)/Common/DataPostHouse 
RtspParser     := $(_prefix)/Common/Rtsp/RtspParser 
RtspClient     := $(_prefix)/Common/RtspLib/RtspClientLib   
RtspServer     := $(_prefix)/Common/RtspLib/RtspServerLib  
async          := $(_prefix)/Common/libasync
ZQSnmp         := $(_prefix)/Common/snmp

JndiClient     := $(_prefix)/Generic/JndiClient
TsHammer       := $(_prefix)/Generic/TsHammer

TianShanCommon := $(_tsdir)/common 
vrep           := $(_tsdir)/common/vrep

TianShanIce    := $(_tsdir)/Ice
StreamService  := $(_tsdir)/StreamService/ServiceLib 
CDNSS          := $(_tsdir)/CDNLib/CDNSS 
EdgeFE         :=$(_tsdir)/CDNLib/EdgeFE
C2Streamer     := $(_tsdir)/CDNLib/CDNSS/C2Streamer
C2Pump         := $(_tsdir)/CDNLib/CDNSS/C2Pump
CRM_C2Locator  := $(_tsdir)/CDNLib/CRM_C2Locator
CRM_A3         := $(_tsdir)/ComcastNGOD/CRM_A3Message
CRM_3dServer   := $(_tsdir)/ComcastNGOD/CRM_3dServer
HttpCRG        := $(_tsdir)/CRG/HttpCRG

SNMPManPkg     := $(_tsdir)/Shell/ZQSNMPManPkg 
ServiceShell   := $(_tsdir)/Shell/ZQAppShell
SystemShell    := $(_tsdir)/Shell/ZQShell 

ContentStore   := $(_csdir)
ContentClient  := $(_csdir)/ContentClient 
CDNCS          := $(_csdir)/MediaClusterCS
MediaClusterCS := $(_csdir)/MediaClusterCS/service
BaseCS         := $(_csdir)/BaseCS
NGODCS         := $(_csdir)/A3CS

RTICap         := $(_tsdir)/CPE/CPH_RTI
Pacing         := $(_tsdir)/CPE/Pacing
CPH_CDN        := $(_tsdir)/CPE/CPH_CDN
CPH_PCAP       := $(_tsdir)/CPE/CPH_PCAP
CPH_C2Propagation := $(_tsdir)/CPE/CPH_C2Propagation
CPH_AquaRec		 := $(_tsdir)/CPE/CPH_AquaRec
CPH_Raw		 		 := $(_tsdir)/CPE/CPH_Raw/CPH_Raw
CPESvc         := $(_tsdir)/CPE/service 
CPEClient      := $(_tsdir)/CPE/service/CPEClient
TrickGen       := $(_tsdir)/CPE/CDNTrickGen 

SNMPAgent      := $(_tsdir)/Sentry/ZQSNMPExtAgent 
SnmpPlug       := $(_tsdir)/Sentry/Plug_EventSender/snmp
WebLayout      := $(_tsdir)/Sentry/webLayout 
TSClient       := $(_tsdir)/Sentry/TSClient
Storage_web    := $(_tsdir)/Sentry/Module/Storage_web
CPCMan_web     := $(_tsdir)/Sentry/CPCMan_web
CPEMan_web     := $(_tsdir)/Sentry/CPEMan_web
ErmMan_web     := $(_tsdir)/Sentry/ErmMan_web
ClibMan_web    := $(_tsdir)/Sentry/ClibMan_web
AdminCtrl_web  := $(_tsdir)/Sentry/AdminCtrl_web
c2loc_web      := $(_tsdir)/CDNLib/Management/c2loc_web
LogPage        := $(_tsdir)/Sentry/LogPage
MsgSender      := $(_tsdir)/Sentry/MsgSender/MsgSender
SysLogger      := $(_tsdir)/Sentry/Module/SysLogSender
Sentry         := $(_tsdir)/Sentry/service 

StreamClient   := $(_tsdir)/StreamSmith/StreamClient 
LSCP           := $(_tsdir)/StreamSmith/LSCP/lscpLib 
SSM_TianShan_S1:= $(_tsdir)/StreamSmith/Modules/SsmTianShanS1_Now
RtspProxy      := $(_tsdir)/StreamSmith/Service 

EventChannel   := $(_tsdir)/EventChannel/service 

EGH_SnmpTrap   := $(_tsdir)/EventGateway/Modules/EGH_SnmpTrap 
EGH_JMS        := $(_tsdir)/EventGateway/Modules/EGH_JMS
EGH_FileWriter := $(_tsdir)/EventGateway/Modules/EGH_FileWriter
EGH_MQTT       := $(_tsdir)/EventGateway/Modules/EGH_MQTT
EGH_SOAP_CME   := $(_tsdir)/EventGateway/Modules/EGH_SOAP/EGH_SOAP_CME
EventGateway   := $(_tsdir)/EventGateway/service 

Action_A3Message := $(_tsdir)/Action/A3Message
EventRuleEngine  := $(_tsdir)/EventRE

ContentLibClient := $(_tsdir)/ContentLib/ContentLibClient
ContentLib       := $(_tsdir)/ContentLib

PHO_SeaChange := $(_tsdir)/AccreditedPath/pho/pho_SeaChange
PHO_HttpSS    := $(_tsdir)/AccreditedPath/pho/pho_HttpSS
PHO_bcast    := $(_tsdir)/AccreditedPath/pho/pho_bcast
PHO_VSS       := $(_tsdir)/VirtualStreamingService/Pho
PHO_ERM       := $(_tsdir)/EdgeRM/Pho_ERM
Weiwoo        := $(_tsdir)/Weiwoo/service

EdgeRM        :=$(_tsdir)/EdgeRM/service
EdgeRMClient  :=$(_tsdir)/EdgeRM/EdgeRMClient
TransportsToQAMDevice:=$(_tsdir)/EdgeRM/StreamLinkParser/StreamLinkParser

PathAdmin     := $(_tsdir)/AccreditedPath/admin

SiteAdmin     := $(_tsdir)/SiteAdmin
EventSender   := $(_tsdir)/Sentry/Plug_EventSender

MHO_MOD       := $(_tsdir)/application/MODPlugIn
MODSvc        := $(_tsdir)/application/MOD2

MHO_GBMOD       := $(_tsdir)/application/GB_MODPlugIn
GBMODApp        := $(_tsdir)/application/GB_MOD2

DummySS       := $(_tsdir)/DummySS
DummySvc      := $(_tsdir)/DummySvc/DummySvc

auth5i        := $(_tsdir)/OpenVBO/auth5icli

StreamPumper  := $(_tsdir)/StreamService/StreamPumper
NSS           := $(_tsdir)/StreamService/NSS
C2SS          := $(_tsdir)/StreamService/C2SS

xmlshd        := $(_prefix)/Generic/xmlshd
GBCS          := $(_prefix)/TianShan/GB-SAC/GBCS

DsmccCRG      := $(_tsdir)/CRG/DsmccCRG
CRM_DSMCC     := $(_tsdir)/CRG/DsmccCRG/crm_dsmcc
TSPump        := $(_tsdir)/CRG/DsmccCRG/TSPumpService

OpenVBO_web   := $(_tsdir)/OpenVBO/OpenVBO_web
SSM_OpenVBO   := $(_tsdir)/OpenVBO/ssm_OpenVBO
SSM_NGOD2     := $(_tsdir)/ComcastNGOD/ssm_ngod
ngod2view     := $(_tsdir)/ComcastNGOD/ngod2view
NGODHist      := $(_tsdir)/ComcastNGOD/ssm_ngod2_logPlugin
SSM_GBstb     := $(_tsdir)/GB-SAC/ssm_GBstb
SSM_GBss      := $(_tsdir)/GB-SAC/ssm_GBss
SSM_Richurl   := $(_tsdir)/StreamSmith/Modules/ssm_richurl
GBVSS         := $(_tsdir)/GB-SAC/GBvss
SSM_LiveChannel:= $(_tsdir)/BroadcastChannel/ssm_LiveChannel

BcastChannel  := $(_tsdir)/BroadcastChannel
BcastChMan_web := $(_tsdir)/Sentry/BcastChMan_web

tslicapp      := $(_tsdir)/FingerPrint/SignatureGenerateCMD

AquaClient    := $(_prefix)/Generic/CdmiFuse/sdk

_mkdep = $(if $(2), $(join $(foreach f, $(1), $(f):), $(2)), $(foreach f, $(1), $($f)))

_mod_rules := MediaClusterCS CDNCS CDNSS EdgeFE HttpCRG CPESvc Sentry RtspProxy EventChannel EventGateway \
			  SystemShell ContentClient StreamClient BaseCS SNMPAgent EventRuleEngine \
			  ContentLib ContentLibClient RTICap CPEClient Weiwoo SiteAdmin MODSvc \
			  PathAdmin DummySS TrickGen NSS C2SS xmlshd GBCS EdgeRM auth5i GBMODApp DsmccCRG EdgeRMClient GBVSS TSPump \
			  BcastChannel DummySvc tslicapp TransportsToQAMDevice CdmiFuse
						  
_lib_rules := ZQCommon TianShanIce TianShanCommon SNMPManPkg ServiceShell \
			  ContentStore StreamService C2Streamer C2Pump HttpEngine DataPostHouse JndiClient vrep RtspClient NGODCS StreamPumper \
			  SSM_TianShan_S1 LSCP RtspParser \
			  EGH_SnmpTrap EGH_JMS EGH_FileWriter EGH_MQTT EGH_SOAP_CME \
			  Pacing CPH_CDN CPH_PCAP CPH_Raw EventSender \
			  CRM_C2Locator CRM_A3 CRM_3dServer \
			  WebLayout TSClient Storage_web CPCMan_web CPEMan_web ErmMan_web ClibMan_web AdminCtrl_web c2loc_web BcastChMan_web SnmpPlug MsgSender LogPage \
			  SysLogger Action_A3Message PHO_SeaChange PHO_HttpSS PHO_bcast PHO_VSS PHO_ERM MHO_MOD RtspServer MHO_GBMOD CRM_DSMCC \
			  OpenVBO_web SSM_OpenVBO SSM_GBstb SSM_GBss SSM_NGOD2 SSM_Richurl SSM_LiveChannel ngod2view NGODHist async ZQSnmp AquaClient
 
_modules := $(call _mkdep, $(_mod_rules))
_library := $(call _mkdep, $(_lib_rules))

_everything := all install clean veryclean  

goal ?= install

default: install

sinclude .depend

.PHONY: $(_everything) $(_modules) $(_library) $(_mod_rules) $(_lib_rules)

.depend: makefile
	@echo "generating dependency file $@ ..."
	$(Q)rm -f $@; \
	echo $(call _mkdep, $(_mod_rules), $(_modules)) | sed 's/ /\n/g' >> $@; \
	echo $(call _mkdep, $(_lib_rules), $(_library)) | sed 's/ /\n/g' >> $@;

$(_everything): 
	@if [ "$@" = "all" -o "$@" = "install" ]; then \
		$(MAKE) $(_modules) || exit 1; \
	else \
		$(MAKE) $(_modules) goal=$@; \
	fi	

$(_modules) $(_library):
	$(Q)$(MAKE) -C $@ $(goal)

help::
	@echo 'Targets:'
	@echo '    clean     - remove object and executables'
	@echo '    veryclean - remove generated source files and dependency files'
	@echo '    install   - build and install all modules (default)'
	@echo 
	@echo 'make verbose =0|1 [target] 0 ==> quiet (default), 1 ==> verbose'
	@echo 'make debug   =0|1 [target] 0 ==> release, 1 ==> debug (default)'
	@echo 'make dbgfile =0|1 generate a seperate symbol file or not'
	@echo 'make <module name> goal= all|install|clean|veryclean'
	@echo 'make <targets>'
	@echo 


# dependencies
#

$(TianShanCommon):  $(ZQCommon) $(TianShanIce)
$(SystemShell):     $(TianShanCommon) $(SNMPManPkg) 
$(ContentStore):    $(TianShanCommon)
$(ContentClient):   $(ZQCommon) $(ContentStore)
$(CDNCS):           $(vrep) $(ContentStore) $(SNMPManPkg) $(ServiceShell)
$(MediaClusterCS):  $(vrep) $(ContentStore) $(SNMPManPkg) $(ServiceShell)
$(BaseCS):          $(ContentStore)
$(StreamClient):    $(ZQCommon) $(TianShanCommon)
$(CRM_C2Locator):   $(TianShanCommon) $(ContentStore) $(SNMPManPkg)
$(CRM_A3):   $(TianShanCommon) $(SNMPManPkg) $(AquaClient) $(ContentStore)
$(CRM_3dServer):    $(TianShanCommon) $(HttpEngine) $(SNMPManPkg)
$(HttpCRG):         $(CRM_C2Locator) $(CRM_A3) $(CRM_3dServer) $(HttpEngine) $(DataPostHouse) \
					$(SNMPManPkg) $(ServiceShell)
$(CPH_PCAP):        $(ZQCommon) $(TianShanCommon) $(SNMPManPkg)
$(CPH_CDN):         $(ZQCommon) $(TianShanCommon) $(Pacing) $(SNMPManPkg)
$(CPH_AquaLib):     $(ZQCommon) $(TianShanCommon) $(Pacing) $(SNMPManPkg) $(AquaClient)
$(CPH_C2Propagation):$(ZQCommon) $(TianShanCommon) $(SNMPManPkg)
$(CPH_Raw):         $(ZQCommon) $(TianShanCommon) $(SNMPManPkg)
$(AquaClient):		$(ZQCommon)
$(RTICap):          $(TianShanCommon)
ifeq ($(_arch),x86_64)
$(CPESvc):          $(SNMPManPkg) $(ServiceShell) $(CPH_CDN) $(CPH_AquaLib) $(CPH_PCAP) $(CPH_C2Propagation) $(CPH_AquaRec) $(CPH_Raw)
else
$(CPESvc):          $(ServiceShell) $(ZQCommon) $(TianShanCommon)
endif
$(EdgeRM):          $(ServiceShell) $(SNMPManPkg) $(ZQCommon) $(TianShanCommon) $(DataPostHouse) $(vrep) $(RtspServer)
$(EdgeRMClient):    $(TianShanCommon)
$(TransportsToQAMDevice):$(TianShanCommon)
$(CPEClient):       $(TianShanCommon)
$(TrickGen):        $(ZQCommon) $(SNMPManPkg)

$(OpenVBO_web):     $(TianShanCommon) $(ZQCommon)
$(ngod2view):       $(TianShanCommon) $(ZQCommon)
$(Sentry):          $(ServiceShell) $(WebLayout) $(DataPostHouse) $(HttpEngine) \
					$(TSClient) $(Storage_web) $(CPCMan_web) $(CPEMan_web) $(ErmMan_web) $(ClibMan_web) $(AdminCtrl_web) $(OpenVBO_web) $(c2loc_web) $(ngod2view) $(BcastChMan_web) \
					$(LogPage) $(SnmpPlug) $(MsgSender) $(SysLogger)
$(WebLayout):       $(ZQCommon)
$(TSClient):        $(TianShanCommon)
$(MsgSender):       $(TianShanCommon)
$(SnmpPlug):        $(TianShanCommon) $(SNMPManPkg)
$(SNMPManPkg):      $(ZQSnmp)
$(ZQSnmp):          $(ZQCommon)

$(SSM_TianShan_S1): $(TianShanCommon)
$(SSM_OpenVBO):     $(TianShanCommon) $(ZQCommon) $(SNMPManPkg)
$(SSM_NGOD2):       $(TianShanCommon) $(ZQCommon) $(SNMPManPkg) $(NGODHist) $(vrep)
$(SSM_LiveChannel): $(TianShanCommon)
$(NGODHist):        $(ZQCommon)
$(SSM_Richurl):     $(ZQCommon)
$(RtspProxy):       $(SNMPManPkg) $(ServiceShell) $(DataPostHouse) $(RtspParser) $(LSCP) $(SSM_TianShan_S1) $(SSM_OpenVBO) $(SSM_NGOD2) $(SSM_Richurl) $(SSM_LiveChannel)
$(StreamService):   $(TianShanCommon)
$(CDNSS):           $(vrep) $(StreamService) $(SNMPManPkg) $(ServiceShell) $(DataPostHouse) $(HttpEngine) $(ContentStore) $(C2Pump) $(async) $(AquaClient)
$(EdgeFE):            $(vrep) $(StreamService) $(SNMPManPkg) $(ServiceShell) $(DataPostHouse) $(HttpEngine) $(ContentStore) $(C2Pump) $(async) $(AquaClient)

$(EventChannel):    $(TianShanCommon) $(SNMPManPkg) $(ServiceShell) 
$(EventGateway):    $(SNMPManPkg) $(ServiceShell) $(EGH_SnmpTrap) $(EGH_JMS) $(EGH_FileWriter) $(EGH_MQTT) $(EGH_SOAP_CME)   
$(EGH_SnmpTrap):    $(TianShanCommon)
$(EGH_JMS):         $(TianShanCommon) $(JndiClient)
$(EGH_FileWriter):  $(ZQCommon)
$(EGH_MQTT):        $(TianShanCommon)
$(EGH_SOAP_CME):    $(TianShanCommon) $(ZQCommon)
$(Action_A3Message):$(TianShanCommon)
$(EventRuleEngine): $(SNMPManPkg) $(ServiceShell) $(Action_A3Message) 

$(ContentLibClient):$(TianShanCommon) 
$(ContentLib):      $(ContentLibClient) $(SNMPManPkg) $(ServiceShell) 

$(JndiClient):      $(ZQCommon)
$(TsHammer):        $(ZQCommon)

$(PHO_SeaChange):   $(TianShanCommon)
$(PHO_HttpSS):      $(TianShanCommon)
$(PHO_bcast):      $(TianShanCommon) 
$(PHO_VSS):         $(TianShanCommon) 
$(PHO_ERM):         $(DataPostHouse) $(TianShanCommon)
$(Weiwoo):          $(ServiceShell) $(SNMPManPkg) $(PHO_SeaChange) $(PHO_HttpSS) $(PHO_VSS) $(PHO_ERM) $(PHO_bcast)

$(PathAdmin):       $(TianShanCommon)

$(SiteAdmin):       $(ServiceShell) $(SNMPManPkg) $(EventSender)
$(EventSender):     $(TianShanCommon) $(JndiClient)

$(MHO_MOD):         $(TianShanCommon)
$(MODSvc):          $(ServiceShell) $(SNMPManPkg) $(MHO_MOD) 

$(MHO_GBMOD):         $(TianShanCommon)
$(GBMODApp):          $(ServiceShell) $(SNMPManPkg) $(MHO_GBMOD) 

$(DummySS):         $(TianShanCommon)
$(DummySvc):        $(TianShanCommon) $(SNMPManPkg) $(ServiceShell)

$(StreamPumper):    $(TianShanCommon)
$(NSS):             $(StreamPumper) $(ContentStore) $(NGODCS) $(ServiceShell) $(SNMPManPkg)
$(async):           $(ZQCommon)
$(C2SS):            $(StreamPumper) $(ServiceShell) $(SNMPManPkg) $(TianShanCommon) $(ZQCommon) $(async)

$(GBCS):            $(StreamPumper) $(ContentStore) $(ServiceShell) $(SNMPManPkg)

$(xmlshd):          $(ZQCommon) $(HttpEngine) $(DataPostHouse) $(SNMPManPkg) $(ServiceShell)

$(CRM_DSMCC):       $(TianShanCommon)
$(DsmccCRG):        $(CRM_DSMCC) $(TianShanCommon) $(DataPostHouse) $(SNMPManPkg) $(ServiceShell) $(LSCP)
$(TSPump):          $(ZQCommon) $(DataPostHouse) $(SNMPManPkg) $(ServiceShell)

$(SSM_GBstb):       $(TianShanCommon) $(ZQCommon) $(SNMPManPkg)
$(SSM_GBss):        $(TianShanCommon) $(ZQCommon) $(SNMPManPkg)
$(GBVSS):           $(ZQCommon) $(SNMPManPkg) $(ServiceShell) $(DataPostHouse) $(TianShanCommon) $(StreamPumper) $(SSM_GBstb) $(SSM_GBss)
$(BcastChMan_web):  $(ZQCommon) $(TianShanCommon) $(SNMPManPkg)
$(BcastChannel):    $(ServiceShell) $(TianShanCommon) $(ZQCommon) $(SNMPManPkg) 

$(tslicapp):        $(ZQCommon)

# vim: ts=4 sw=4 noexpandtab

